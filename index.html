<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA Music - Production</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#050505">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      color-scheme: dark;
      --bg: #050505;
      --accent: #bc77ff;
      --border-soft: rgba(255, 255, 255, 0.1);
      --text-main: #f5f5f5;
      --text-muted: #9b9b9b;
      --radius-lg: 24px;
      --radius-md: 18px;
      --radius-sm: 999px;
      --blur-strong: 20px;
      --transition-fast: 150ms ease-out;
      --transition-med: 220ms ease-out;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      color: var(--text-main);
      font-family: -apple-system, BlinkMacSystemFont, system-ui, "SF Pro Text", sans-serif;
      overscroll-behavior: none;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .app-shell {
      position: relative;
      width: 100%;
      max-width: 420px;
      height: 100%;
      max-height: 900px;
      border-radius: 32px;
      background: radial-gradient(circle at top, #171717 0, #050505 55%, #000 100%);
      overflow: hidden;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.04), 0 40px 80px rgba(0,0,0,0.9);
    }

    @supports (height: 100dvh) {
      .app-shell { height: 100dvh; }
    }

    @media (max-width: 600px) {
      body { padding: 0; }
      .app-shell { max-width: 100%; max-height: 100%; border-radius: 0; box-shadow: none; }
    }

    .app-bg-blur {
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0.45;
      background:
        radial-gradient(circle at 0% 0%, rgba(188,119,255,0.4), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(102,51,255,0.25), transparent 55%);
      filter: blur(60px);
      transform: scale(1.2);
    }

    .loader-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 180ms ease-out;
      z-index: 5;
    }
    .loader-overlay.visible {
      opacity: 1;
      pointer-events: auto;
      background: radial-gradient(circle at 50% 0%, rgba(5,5,5,0.9), rgba(5,5,5,0.96));
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .loader-pulse {
      width: 46px;
      height: 46px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.16);
      background: radial-gradient(circle at 30% 0%, rgba(255,255,255,0.9), rgba(188,119,255,0.7));
      box-shadow: 0 0 0 0 rgba(188,119,255,0.4), 0 18px 40px rgba(0,0,0,1);
      animation: loaderPulse 1.2s infinite ease-out;
    }
    @keyframes loaderPulse {
      0% { box-shadow: 0 0 0 0 rgba(188,119,255,0.4), 0 18px 40px rgba(0,0,0,1); }
      70% { box-shadow: 0 0 0 18px rgba(188,119,255,0), 0 18px 40px rgba(0,0,0,1); }
      100% { box-shadow: 0 0 0 0 rgba(188,119,255,0), 0 18px 40px rgba(0,0,0,1); }
    }

    .app-inner {
      position: relative;
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: calc(env(safe-area-inset-top, 0px) + 10px) 12px calc(env(safe-area-inset-bottom, 0px) + 10px);
      z-index: 1;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px 10px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo-icon {
      width: 26px;
      height: 26px;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 0%, #ffffff, #bc77ff);
      box-shadow: 0 0 22px rgba(188,119,255,0.9), 0 0 0 1px rgba(255,255,255,0.15);
    }
    .logo-title {
      font-weight: 600;
      letter-spacing: 0.06em;
      font-size: 13px;
      text-transform: uppercase;
    }
    .logo-sub {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }
    .logo-text { display: flex; flex-direction: column; }

    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 0 4px;
      overflow: hidden;
    }

    .views {
      position: relative;
      flex: 1;
      overflow: hidden;
      margin-top: 4px;
    }

    .view {
      position: absolute;
      inset: 0;
      opacity: 0;
      pointer-events: none;
      transform: translateX(24px);
      transition: opacity var(--transition-med), transform var(--transition-med);
      overflow-y: auto;
      padding-bottom: 80px;
      padding-right: 4px;
    }
    .view.active {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(0);
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin: 4px 2px 8px;
    }
    .section-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin: 0 2px 14px;
    }

    .vibe-card {
      border-radius: var(--radius-lg);
      padding: 14px 14px 10px;
      background: radial-gradient(circle at 0% 0%, rgba(188,119,255,0.18), rgba(10,10,10,0.9));
      border: 1px solid var(--border-soft);
      backdrop-filter: blur(var(--blur-strong));
      box-shadow: 0 20px 45px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.03);
      margin-bottom: 16px;
      transition: all 180ms ease-out;
    }
    .vibe-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .vibe-label { font-size: 13px; font-weight: 500; }
    .vibe-value {
      font-size: 12px;
      color: var(--accent);
      text-shadow: 0 0 8px rgba(188,119,255,0.9);
    }
    .vibe-slider-wrapper { position: relative; margin-top: 2px; }
    .vibe-gradient-track {
      position: absolute;
      inset: 50% 0 auto 0;
      transform: translateY(-50%);
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(188,119,255,0.2), rgba(188,119,255,0.8));
      pointer-events: none;
      opacity: 0.7;
    }
    .vibe-slider {
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      height: 20px;
    }
    .vibe-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid var(--accent);
      box-shadow: 0 0 18px rgba(188,119,255,0.7), 0 0 0 6px rgba(188,119,255,0.25);
      cursor: pointer;
      margin-top: -6px;
      transition: all var(--transition-fast);
    }
    .vibe-slider:active::-webkit-slider-thumb {
      transform: scale(0.95);
      box-shadow: 0 0 26px rgba(188,119,255,1), 0 0 0 8px rgba(188,119,255,0.28);
    }
    .vibe-footer {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
    }

    .tracks-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 16px;
    }

    .track-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      border-radius: var(--radius-md);
      background: rgba(9,9,9,0.9);
      border: 1px solid var(--border-soft);
      backdrop-filter: blur(var(--blur-strong));
      box-shadow: 0 14px 30px rgba(0,0,0,0.85), 0 0 0 1px rgba(255,255,255,0.03);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .track-card:active {
      transform: scale(0.97);
      box-shadow: 0 8px 20px rgba(0,0,0,0.95), 0 0 0 1px rgba(255,255,255,0.08);
      background: rgba(14,14,14,0.95);
    }

    .track-cover {
      width: 48px;
      height: 48px;
      border-radius: 16px;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
      box-shadow: 0 12px 24px rgba(0,0,0,0.9), 0 0 0 1px rgba(255,255,255,0.08);
    }

    .track-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .track-title {
      font-size: 15px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 2px;
    }
    .track-artist {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .track-meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .track-pill {
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.02);
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      white-space: nowrap;
    }

    .track-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
      margin-left: 8px;
    }

    .icon-button {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(15,15,15,0.96);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(0,0,0,0.9), 0 0 0 1px rgba(255,255,255,0.05);
      transition: all var(--transition-fast);
    }
    .icon-button:active {
      transform: scale(0.92);
      box-shadow: 0 4px 12px rgba(0,0,0,1), 0 0 0 1px rgba(255,255,255,0.12);
      background: rgba(25,25,25,0.96);
    }

    .icon-heart {
      width: 14px;
      height: 14px;
      position: relative;
      transform: translateY(1px);
    }
    .icon-heart::before, .icon-heart::after {
      content: "";
      position: absolute;
      width: 8px;
      height: 12px;
      background: rgba(255,255,255,0.6);
      border-radius: 8px 8px 0 0;
      transform-origin: bottom center;
    }
    .icon-heart::before { left: 3px; transform: rotate(-45deg); }
    .icon-heart::after { right: 3px; transform: rotate(45deg); }
    .icon-heart.liked::before, .icon-heart.liked::after {
      background: var(--accent);
      box-shadow: 0 0 12px rgba(188,119,255,0.8);
    }

    .icon-download {
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid rgba(255,255,255,0.9);
      position: relative;
    }
    .icon-download::before {
      content: "";
      position: absolute;
      width: 10px;
      height: 2px;
      background: rgba(255,255,255,0.9);
      top: -3px;
      left: -5px;
    }

    .icon-share {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.9);
      position: relative;
    }
    .icon-share::before, .icon-share::after {
      content: "";
      position: absolute;
      width: 2px;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
    }
    .icon-share::before { left: 5px; top: -3px; transform: rotate(45deg); }
    .icon-share::after { left: 5px; top: 4px; transform: rotate(-45deg); }

    .search-header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }
    .search-input-wrapper { position: relative; }
    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.5);
    }
    .search-icon::after {
      content: "";
      position: absolute;
      width: 8px;
      height: 2px;
      border-radius: 999px;
      background: rgba(255,255,255,0.7);
      right: -4px;
      bottom: 1px;
      transform: rotate(45deg);
    }
    .search-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(10,10,10,0.96);
      backdrop-filter: blur(18px);
      padding: 12px 16px 12px 40px;
      font-size: 15px;
      color: var(--text-main);
      outline: none;
      box-shadow: 0 12px 28px rgba(0,0,0,0.9), 0 0 0 1px rgba(255,255,255,0.02);
      transition: all var(--transition-fast);
    }
    .search-input::placeholder { color: var(--text-muted); }
    .search-input:focus {
      border-color: rgba(188,119,255,0.6);
      box-shadow: 0 16px 40px rgba(0,0,0,1), 0 0 0 1px rgba(188,119,255,0.4);
    }

    .search-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .chip {
      font-size: 12px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(12,12,12,0.95);
      backdrop-filter: blur(18px);
      cursor: pointer;
      transition: all var(--transition-fast);
      font-weight: 500;
    }
    .chip:active {
      transform: scale(0.96);
      border-color: rgba(188,119,255,0.6);
      background: rgba(188,119,255,0.15);
      box-shadow: 0 12px 28px rgba(188,119,255,0.3);
    }

    .search-empty {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 24px;
      text-align: center;
      padding: 20px;
    }

    .library-group { margin-bottom: 20px; }
    .library-group-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .library-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: var(--radius-md);
      background: rgba(12,12,12,0.96);
      border: 1px solid var(--border-soft);
      backdrop-filter: blur(18px);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .library-row:active {
      transform: scale(0.98);
      background: rgba(18,18,18,0.96);
      box-shadow: 0 8px 24px rgba(0,0,0,0.95);
    }
    .library-thumb {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(188,119,255,0.8), rgba(20,20,20,0.9));
      box-shadow: 0 12px 24px rgba(0,0,0,0.9);
    }

    .mini-player {
      margin: 0 4px 12px;
      padding: 14px 16px;
      border-radius: 20px;
      background: rgba(10,10,10,0.96);
      border: 1px solid var(--border-soft);
      backdrop-filter: blur(20px);
      box-shadow: 0 20px 48px rgba(0,0,0,0.95), 0 0 0 1px rgba(255,255,255,0.03);
      display: flex;
      align-items: center;
      gap: 12px;
      transform: translateY(100%);
      opacity: 0;
      pointer-events: none;
      transition: all 280ms ease-out;
    }
    .mini-player.active {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .mini-cover {
      width: 44px;
      height: 44px;
      border-radius: 16px;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
      box-shadow: 0 16px 32px rgba(0,0,0,0.9), 0 0 0 1px rgba(255,255,255,0.08);
    }
    .mini-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .mini-title {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .mini-artist {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .mini-progress-wrapper {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .mini-time {
      font-size: 10px;
      color: var(--text-muted);
      width: 32px;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }
    .mini-progress {
      flex: 1;
      height: 4px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      overflow: hidden;
    }
    .mini-progress-inner {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, rgba(188,119,255,0.4), var(--accent));
      box-shadow: 0 0 16px rgba(188,119,255,0.6);
      transition: width 100ms linear;
    }

    .mini-play {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 16px 36px rgba(0,0,0,0.95), 0 0 0 1px rgba(255,255,255,0.15);
      transition: all var(--transition-fast);
    }
    .mini-play:active {
      transform: scale(0.94);
      box-shadow: 0 12px 24px rgba(0,0,0,1), 0 0 0 1px rgba(255,255,255,0.2);
    }
    .mini-play-icon {
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 8px 0 8px 12px;
      border-color: transparent transparent transparent #050505;
      transform: translateX(1px);
    }
    .mini-play-icon.pause {
      width: 12px;
      height: 12px;
      border: none;
      box-sizing: content-box;
      display: flex;
      gap: 2px;
    }
    .mini-play-icon.pause::before, .mini-play-icon.pause::after {
      content: "";
      width: 4px;
      height: 12px;
      border-radius: 2px;
      background: #050505;
    }

    .tab-bar {
      display: flex;
      gap: 6px;
      padding: 10px 8px 8px;
      margin-top: 8px;
    }
    .tab-item {
      flex: 1;
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      border: 1px solid transparent;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .tab-item:active { transform: scale(0.98); }
    .tab-item.active {
      color: #ffffff;
      border-color: rgba(255,255,255,0.2);
      background: rgba(12,12,12,0.95);
      box-shadow: 0 12px 28px rgba(0,0,0,0.9), 0 0 0 1px rgba(255,255,255,0.1);
    }
    .tab-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 12px rgba(188,119,255,0.9);
    }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 999px; }
    ::-webkit-scrollbar-track { background: transparent; }
  </style>
</head>
<body>
<div class="app-shell">
  <div class="app-bg-blur"></div>
  <div class="loader-overlay" id="loader">
    <div class="loader-pulse"></div>
  </div>

  <div class="app-inner">
    <div class="top-bar">
      <div class="logo">
        <div class="logo-icon"></div>
        <div class="logo-text">
          <div class="logo-title">AURA</div>
          <div class="logo-sub">Music</div>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="views">
        <div class="view active" id="view-home">
          <h2 class="section-title">Today's Vibe</h2>
          <p class="section-subtitle">Slide to set your mood, search instantly</p>

          <div class="vibe-card" id="vibeCard">
            <div class="vibe-header">
              <div class="vibe-label">Energy Level</div>
              <div class="vibe-value" id="vibeValue">42%</div>
            </div>
            <div class="vibe-slider-wrapper">
              <div class="vibe-gradient-track"></div>
              <input id="vibeSlider" class="vibe-slider" type="range" min="0" max="100" value="42">
            </div>
            <div class="vibe-footer">
              <span>Chill</span>
              <span>Hyper</span>
            </div>
          </div>

          <div class="tracks-grid" id="homeTracks"></div>
        </div>

        <div class="view" id="view-search">
          <h2 class="section-title">Search Music</h2>
          <p class="section-subtitle">Real-time Jamendo catalog. Any mood, any artist.</p>

          <div class="search-header">
            <div class="search-input-wrapper">
              <div class="search-icon"></div>
              <input id="searchInput" class="search-input" type="text" placeholder="Type to search...">
            </div>
            <div class="search-categories" id="searchChips">
              <button class="chip" data-query="ambient">Ambient</button>
              <button class="chip" data-query="chill">Chill</button>
              <button class="chip" data-query="rock">Rock</button>
              <button class="chip" data-query="lofi">Lo-fi</button>
              <button class="chip" data-query="techno">Techno</button>
            </div>
          </div>

          <div id="searchResults"></div>
          <div class="search-empty" id="searchEmpty">Start typing to discover music from Jamendo</div>
        </div>

        <div class="view" id="view-library">
          <h2 class="section-title">Your Library</h2>
          <p class="section-subtitle">Saved tracks and collections</p>

          <div class="library-group">
            <div class="library-group-title">Collections</div>
            <div class="library-row">
              <div class="library-thumb"></div>
              <div style="flex:1">
                <div style="font-size:13px;font-weight:500;margin-bottom:2px">Night Drive</div>
                <div style="font-size:11px;color:var(--text-muted)">Curated for late night coding</div>
              </div>
              <div class="track-pill">Mix</div>
            </div>
          </div>

          <div class="library-group">
            <div class="library-group-title">Liked Tracks</div>
            <div id="libraryTracks"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="mini-player" id="miniPlayer">
      <div class="mini-cover" id="miniCover"></div>
      <div class="mini-info">
        <div class="mini-title" id="miniTitle">—</div>
        <div class="mini-artist" id="miniArtist">—</div>
        <div class="mini-progress-wrapper">
          <div class="mini-time" id="miniCurrentTime">0:00</div>
          <div class="mini-progress">
            <div class="mini-progress-inner" id="miniProgress"></div>
          </div>
          <div class="mini-time" id="miniDurationTime">0:00</div>
        </div>
      </div>
      <button class="mini-play" id="miniPlayBtn">
        <div class="mini-play-icon" id="miniPlayIcon"></div>
      </button>
    </div>

    <div class="tab-bar">
      <button class="tab-item active" data-view="home">
        <span class="tab-dot"></span>
        <span>Home</span>
      </button>
      <button class="tab-item" data-view="search">
        <span>Search</span>
      </button>
      <button class="tab-item" data-view="library">
        <span>Library</span>
      </button>
    </div>
  </div>
</div>

<script>
  // Telegram WebApp init
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.expand();
    tg.setBackgroundColor('#050505');
    tg.setHeaderColor('#050505');
  }

  // App state
  const JAMENDO_CLIENT_ID = '56d30cce';
  const JAMENDO_BASE = 'https://api.jamendo.com/v3.0';
  
  let currentTrack = null;
  let isPlaying = false;
  let progressInterval = null;
  let likedTracks = JSON.parse(localStorage.getItem('aura_liked') || '[]');
  let searchController = null;
  let vibeLevel = 42;
  let searchTimeout = null;

  // DOM elements
  const elements = {
    loader: document.getElementById('loader'),
    views: {
      home: document.getElementById('view-home'),
      search: document.getElementById('view-search'),
      library: document.getElementById('view-library')
    },
    tabs: document.querySelectorAll('.tab-item'),
    vibe: {
      slider: document.getElementById('vibeSlider'),
      value: document.getElementById('vibeValue'),
      card: document.getElementById('vibeCard')
    },
    homeTracks: document.getElementById('homeTracks'),
    search: {
      input: document.getElementById('searchInput'),
      chips: document.getElementById('searchChips'),
      results: document.getElementById('searchResults'),
      empty: document.getElementById('searchEmpty')
    },
    library: document.getElementById('libraryTracks'),
    player: {
      mini: document.getElementById('miniPlayer'),
      cover: document.getElementById('miniCover'),
      title: document.getElementById('miniTitle'),
      artist: document.getElementById('miniArtist'),
      progress: document.getElementById('miniProgress'),
      currentTime: document.getElementById('miniCurrentTime'),
      durationTime: document.getElementById('miniDurationTime'),
      playBtn: document.getElementById('miniPlayBtn'),
      playIcon: document.getElementById('miniPlayIcon')
    }
  };

  const audio = new Audio();
  audio.crossOrigin = 'anonymous';
  audio.preload = 'metadata';

  // Core functions
  function showLoader() { elements.loader.classList.add('visible'); }
  function hideLoader() { elements.loader.classList.remove('visible'); }

  function formatTime(seconds) {
    seconds = Math.floor(seconds || 0);
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  function getVibeTag() {
    if (vibeLevel <= 30) return 'ambient chill';
    if (vibeLevel >= 70) return 'techno energetic dance';
    return 'rock indie pop';
  }

  function updateVibeUI(value) {
    vibeLevel = Number(value);
    elements.vibe.value.textContent = `${vibeLevel}%`;
    
    const glow = 12 + (vibeLevel / 100) * 24;
    const bgAlpha = 0.18 + (vibeLevel / 100) * 0.22;
    
    elements.vibe.card.style.boxShadow = 
      `0 24px 48px rgba(0,0,0,0.9), 0 0 ${glow}px rgba(188,119,255,0.6), 0 0 0 1px rgba(255,255,255,0.08)`;
    elements.vibe.card.style.background = 
      `radial-gradient(circle at 0% 0%, rgba(188,119,255,${bgAlpha}), rgba(10,10,10,0.95))`;
  }

  function updatePlayerUI() {
    if (!currentTrack) return;
    
    elements.player.title.textContent = currentTrack.name || 'Unknown Track';
    elements.player.artist.textContent = currentTrack.artist_name || 'Unknown Artist';
    elements.player.cover.style.backgroundImage = `url(${currentTrack.image || ''})`;
    elements.player.durationTime.textContent = formatTime(currentTrack.duration);
  }

  function setPlayingState(playing) {
    isPlaying = playing;
    elements.player.playIcon.classList.toggle('pause', playing);
  }

  function startProgress() {
    if (progressInterval) clearInterval(progressInterval);
    progressInterval = setInterval(() => {
      if (audio.duration) {
        const progress = (audio.currentTime / audio.duration) * 100;
        elements.player.progress.style.width = `${progress}%`;
        elements.player.currentTime.textContent = formatTime(audio.currentTime);
      }
    }, 500);
  }

  function stopProgress() {
    if (progressInterval) {
      clearInterval(progressInterval);
      progressInterval = null;
    }
  }

  function setupMediaSession() {
    if ('mediaSession' in navigator && currentTrack) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: currentTrack.name || '',
        artist: currentTrack.artist_name || '',
        album: currentTrack.album_name || 'AURA Music',
        artwork: currentTrack.image ? [
          { src: currentTrack.image, sizes: '96x96', type: 'image/jpeg' },
          { src: currentTrack.image, sizes: '192x192', type: 'image/jpeg' }
        ] : []
      });

      navigator.mediaSession.setActionHandler('play', () => audio.play());
      navigator.mediaSession.setActionHandler('pause', () => audio.pause());
      navigator.mediaSession.setActionHandler('stop', () => {
        audio.pause();
        audio.currentTime = 0;
      });
      navigator.mediaSession.playbackState = isPlaying ? 'playing' : 'paused';
    }
  }

  async function searchJamendo(query, limit = 20) {
    const vibeTag = getVibeTag();
    const searchQuery = query ? `${query} ${vibeTag}` : vibeTag;
    
    const url = new URL(`${JAMENDO_BASE}/tracks/`);
    url.searchParams.set('client_id', JAMENDO_CLIENT_ID);
    url.searchParams.set('format', 'json');
    url.searchParams.set('limit', limit);
    url.searchParams.set('search', searchQuery);
    url.searchParams.set('audioformat', 'mp31');

    if (searchController) searchController.abort();
    searchController = new AbortController();

    showLoader();
    try {
      const response = await fetch(url, { signal: searchController.signal });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      return data.results || [];
    } catch (error) {
      console.error('Jamendo search failed:', error);
      return [];
    } finally {
      hideLoader();
    }
  }

  function createTrackCard(track) {
    const card = document.createElement('div');
    card.className = 'track-card';

    const cover = document.createElement('div');
    cover.className = 'track-cover';
    cover.style.backgroundImage = `url(${track.image || ''})`;

    const info = document.createElement('div');
    info.className = 'track-info';
    info.innerHTML = `
      <div class="track-title">${track.name || 'Unknown'}</div>
      <div class="track-artist">${track.artist_name || 'Unknown'}</div>
      <div class="track-meta">${track.album_name || 'Jamendo'} · ${formatTime(track.duration)}</div>
    `;

    const pill = document.createElement('div');
    pill.className = 'track-pill';
    pill.textContent = 'Jamendo';

    const actions = document.createElement('div');
    actions.className = 'track-actions';

    // Like button
    const likeBtn = document.createElement('button');
    likeBtn.className = 'icon-button';
    const heart = document.createElement('div');
    heart.className = `icon-heart ${likedTracks.some(t => t.id === track.id) ? 'liked' : ''}`;
    likeBtn.appendChild(heart);
    likeBtn.onclick = (e) => {
      e.stopPropagation();
      toggleLike(track);
    };

    // Download button
    const downloadBtn = document.createElement('button');
    downloadBtn.className = 'icon-button';
    downloadBtn.innerHTML = '<div class="icon-download"></div>';
    downloadBtn.onclick = (e) => {
      e.stopPropagation();
      downloadTrack(track);
    };

    // Share button
    const shareBtn = document.createElement('button');
    shareBtn.className = 'icon-button';
    shareBtn.innerHTML = '<div class="icon-share"></div>';
    shareBtn.onclick = (e) => {
      e.stopPropagation();
      shareTrack(track);
    };

    actions.append(likeBtn, downloadBtn, shareBtn);

    card.append(cover, info, pill, actions);

    card.onclick = () => playTrack(track);
    return card;
  }

  function playTrack(track) {
    const audioUrl = track.audiodownload || track.audio;
    if (!audioUrl) return;

    currentTrack = track;
    audio.src = audioUrl;
    audio.currentTime = 0;
    
    elements.player.mini.classList.add('active');
    updatePlayerUI();
    setPlayingState(false);
    setupMediaSession();

    audio.play().then(() => {
      setPlayingState(true);
      startProgress();
    }).catch(console.error);
  }

  function toggleLike(track) {
    const index = likedTracks.findIndex(t => t.id === track.id);
    if (index > -1) {
      likedTracks.splice(index, 1);
    } else {
      likedTracks.push(track);
    }
    localStorage.setItem('aura_liked', JSON.stringify(likedTracks));
    renderLibrary();
  }

  function downloadTrack(track) {
    const url = track.audiodownload || track.audio;
    if (url) {
      const a = document.createElement('a');
      a.href = url;
      a.download = `${(track.name || 'track').replace(/[^\w]/g, '_')}.mp3`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  }

  function shareTrack(track) {
    const text = `${track.name || 'Track'} — ${track.artist_name || 'Artist'}`;
    const url = track.shareurl || track.shorturl || window.location.href;
    
    if (navigator.share) {
      navigator.share({ title: 'AURA Music', text, url });
    } else if (tg) {
      tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`);
    } else {
      navigator.clipboard.writeText(url);
    }
  }

  function renderTracks(container, tracks) {
    container.innerHTML = '';
    if (!tracks.length) {
      container.parentElement.querySelector('.search-empty')?.remove();
      const empty = document.createElement('div');
      empty.className = 'search-empty';
      empty.textContent = 'No tracks found. Try different keywords.';
      container.parentElement.appendChild(empty);
      return;
    }
    tracks.forEach(track => container.appendChild(createTrackCard(track)));
  }

  function renderLibrary() {
    renderTracks(elements.library, likedTracks);
    if (!likedTracks.length) {
      const empty = document.createElement('div');
      empty.className = 'search-empty';
      empty.textContent = 'Like tracks by tapping ❤️ to save them here';
      elements.library.parentElement.appendChild(empty);
    }
  }

  function switchView(viewName) {
    Object.values(elements.views).forEach(view => view.classList.remove('active'));
    elements.views[viewName].classList.add('active');
    
    elements.tabs.forEach(tab => {
      tab.classList.toggle('active', tab.dataset.view === viewName);
    });
  }

  // Event listeners
  elements.vibe.slider.addEventListener('input', (e) => {
    updateVibeUI(e.target.value);
    if (elements.search.input.value) debouncedSearch();
  });

  elements.search.input.addEventListener('input', debouncedSearch);

  elements.search.chips.addEventListener('click', (e) => {
    const chip = e.target.closest('.chip');
    if (chip) {
      elements.search.input.value = chip.dataset.query;
      debouncedSearch();
    }
  });

  elements.player.playBtn.onclick = () => {
    if (!currentTrack) return;
    if (isPlaying) {
      audio.pause();
    } else {
      audio.play().catch(console.error);
    }
  };

  elements.tabs.forEach(tab => {
    tab.onclick = () => switchView(tab.dataset.view);
  });

  // Audio events
  audio.addEventListener('play', () => {
    setPlayingState(true);
    startProgress();
    setupMediaSession();
  });

  audio.addEventListener('pause', () => {
    setPlayingState(false);
    stopProgress();
  });

  audio.addEventListener('ended', () => {
    setPlayingState(false);
    stopProgress();
    elements.player.progress.style.width = '0%';
    elements.player.currentTime.textContent = '0:00';
  });

  audio.addEventListener('loadedmetadata', updatePlayerUI);

  // Search debounce
  function debouncedSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
      const query = elements.search.input.value.trim();
      if (!query) {
        elements.search.chips.style.display = 'flex';
        elements.search.results.innerHTML = '';
        elements.search.empty.textContent = 'Start typing to discover music';
        return;
      }
      
      elements.search.chips.style.display = 'none';
      const tracks = await searchJamendo(query, 20);
      renderTracks(elements.search.results, tracks);
    }, 400);
  }

  // Init
  updateVibeUI(42);
  renderLibrary();

  // Load home tracks
  searchJamendo('chill', 8).then(tracks => {
    renderTracks(elements.homeTracks, tracks);
  });

  // Prevent pull-to-refresh
  let touchStartY = 0;
  document.addEventListener('touchstart', (e) => {
    touchStartY = e.touches[0].clientY;
  }, { passive: true });

  document.addEventListener('touchmove', (e) => {
    if (window.scrollY === 0) {
      const touchY = e.touches[0].clientY;
      if (touchY - touchStartY > 10) {
        e.preventDefault();
      }
    }
  }, { passive: false });
</script>
</body>
</html>
